<!doctype html>
<title>socket.io graph</title>
<script src="/socket.io/socket.io.js"></script>
<script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1/i18n/jquery.ui.datepicker-ja.min.js"></script>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/ui-lightness/jquery-ui.css" >
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.js"></script>
<body>
  <center>
    <p>Today"s lux graph</p>
    <canvas id="myChart1"></canvas>
    <p>lux graph</p>
    <canvas id="myChart2"></canvas>
    <form name="day">
      <input type="text" id="datepicker" size="10">
      <input type="button" id="displaybt" value="display" onclick="func();">
    </form>
  </center>
<body>
<script>
  $(function() {
    $("#datepicker").datepicker();
  });
    let func = function () {
    var myChart2 = new Chart(ctx2, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "lux",
        data: [],
        backgroundColor: "rgba(153,255,51,0.4)"
          }]
    },
    options: {
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true,
            min: 0,
          }
        }]
      }
    }
    });
    let time = moment(document.day.datepicker.value).format("YYYY-MM-DD");
    //$.get("/lux/getdata?time="+time);
    $.get("/lux/getdata",{time: time}, function(data) {
      console.log(data);
      for (let i in data) {
        addData(myChart2, moment(data[i].time).format("HH:mm"), data[i].lux);
      }
    });
  };
</script>
<script>
  var ctx1 = document.getElementById("myChart1").getContext("2d");
  var myChart1 = new Chart(ctx1, {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      label: "lux",
      data: [],
      backgroundColor: "rgba(153,255,51,0.4)"
        }]
  },
  options: {
    scales: {
      yAxes: [{
        ticks: {
          beginAtZero: true,
          min: 0,
        }
      }]
    }
  }
  });

  var socket = io();
  
  socket.on("first connect", function(data) {
    console.log(data);
    for (let i in data) {
      addData(myChart1, moment(data[i].time).format("HH:mm"), data[i].lux);
    }
  });

  socket.on("new lux", function(data) {
    console.log(data.time);
    addData(myChart1, data.time, data.lux);
  });
  
  var ctx2 = document.getElementById("myChart2").getContext("2d");
  var myChart2 = new Chart(ctx2, {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      label: "lux",
      data: [],
      backgroundColor: "rgba(153,255,51,0.4)"
        }]
  },
  options: {
    scales: {
      yAxes: [{
        ticks: {
          beginAtZero: true,
          min: 0,
        }
      }]
    }
  }
  });
  
  function addData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets.forEach((dataset) => {
      dataset.data.push(data);
    });
    chart.update();
  }
</script>
